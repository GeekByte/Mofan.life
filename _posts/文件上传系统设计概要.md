---
title: 文件上传系统设计概要
categories:
  - 技术
tags:
  - 技术
date: 2021-09-14 15:23:41
---

文件上传顾名思义就是将文件从一台机器传到另一台机器中。小文件的传输比较简单，对于大文件的传输有很多有意思的设计，这里围绕其设计思想进行简单介绍。

### 文件分块

文件分块是一个比较常用方式，在发送文件前，将一个大文件分成多个连续的小文件，然后一块一块的发送。当然，对于每一块文件，在发送时还要加入一些额外信息，方便接收端拼接还原文件，这些信息包括：当前文件块数、文件块总数、文件块大小、原文件标识(MD5)等。

<img src="https://www.cmdbyte.com/2021/640%20(7).webp" alt="文件分块" style="zoom: 70%;" />

### 并发上传

并发上传是在文件分块的基础上进行的，可以提高文件整体的传输效率。不过要根据网络情况决定是否并发上传以及同时进行多少个文件块的上传。在技术上比顺序发送复杂些，因为不同线程传输的速度可能不同，接收端需要做缓存。

<img src="https://www.cmdbyte.com/2021/640%20(8).webp" alt="并发上传" style="zoom:90%;" />

### 断点续传

断点续传是为了解决因一些因素导致传输中断后，再次上传必须从0开始传的问题。

其原理是在文件分块的基础上，服务器记录一下原文件对应的上传进度，每接收到一个块，就更新一下进度。这样，即使网络故障导致上传失败，下次上传时，可以直接从失败的那个块开始上传，而不需要再从第 0 块上传。

<img src="https://www.cmdbyte.com/2021/640%20(9).webp" alt="断点续传" style="zoom:80%;" />

### 秒传

提起秒传可能有些陌生，但在使用百度网盘时你可能接触过秒传技术。比如你从网上下载了一个文件（视频或图片），你想把它再放到网盘中，但是在上传时发现明明快一个G的文件竟直接上传成功了，按照你自己的网速可能需要十分钟时间，其实这就是秒传技术的一个应用。

在上传文件前，客户端首先根据文件内容计算出文件对应的MD5值，相同MD5值的文件必然相同，然后先发送该值到服务器中，服务器在数据库中检索该值是否已经存在，如果存在说明该文件已经上传过（可能是其他人上传的），那么直接提示文件上传成功，如果没上传过就走文件的上传逻辑，所以需要等待文件上传成功，上传成功后还会保存文件的MD5值，这样其他用户上传同样的文件时，也可以使用秒传技术了。

> 不过要注意，不同内容文件的 MD5 值也可能会相同（碰撞），导致用户下载到不是自己上传的文件，所以检验重复时，还可以补充一些校验，比如针对文件前几位再生成一个 MD5、用其他 Hash 算法再生成一个校验值等。这里所说的MD5默认每个文件的MD5都是唯一的。

### 异步上传

除了同步上传外，当我们要上传的文件不在本地而是已经存在对应 url 时，也可以采用 **全异步上传** 的方式，将文件上传变成一个 **任务** 。

用户输入要上传的文件 url，点击上传后，不需要一直在文件上传页面等着，而是只需要告诉后台 “我要执行文件上传”，并向后台新建一个文件上传任务，就可以快速响应用户了，比如 “文件上传中，请留意通知”。等后台取出并真正完成文件上传的任务后，给用户发送通知就可以了。

<img src="https://www.cmdbyte.com/2021/640%20(10).webp" alt="异步上传" style="zoom:80%;" />
