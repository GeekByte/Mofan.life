---
title: 配置Sphinx并支持Markdown及表格
categories:
  - Tools
  - Sphinx
tags:
  - Sphinx
  - Markdown
date: 2021-04-08 18:48:14
---

在公司同事的提议下，说能不能用`Sphinx`做一个web形式的接口文档，于是我研究了一番，由于`Sphinx`默认支持的`rst`格式的文档，所以第一个问题就是让它支持`Markdown`格式的文档，再就是考虑到接口文档会有表格对字段进行说明，所以，还需要让它支持`Markdown`形式的表格，从这两个点出发也遇到了下面几个问题：

1. 我是在一台`Ubuntu 16.04` 的机器上进行的，默认的`Python`版本是 `2.7` 和 `3.5`，`Sphinx` 官网推荐安装方式是使用 `Pip` 安装，由于系统默认没有 `Pip`，于是我就安装了`python2`的`Pip`，即`python-pip`，但是运行 `Pip` 却出错，看错误应该是兼容性问题，于是卸载并安装了`Python3`的`Pip`，即`python3-pip`，能用，但是导入支持表格的插件时总是提示导入失败。
2. 环境搭建好，在写文档的时候，又涉及到目录的问题，官方文档对目录这块说的很模糊，几乎没有参考价值，在网上搜答案基本也都对目录这块没什么描述，最终，在看官方文档时闪过一个灵感，经过多次尝试，最终满足了自己的需求。

由于官网的文档都是英文的，如果你不爱看英文文章，也想`quick start`，那么这篇文章可以满足你的基本需求。

### Pip的问题

对于上面描述中的 `Pip` 问题的解决，我的思路是去官方网站安装 `Python` 并作为系统默认 `Python` 使用。

参考我的这篇文章：[Linux安装Python和配置Pip - Mofan ](https://www.mofan.life/2021/04/08/Linux%E5%AE%89%E8%A3%85Python%E5%92%8C%E9%85%8D%E7%BD%AEPip/)

### 安装过程

如果使用`Pip`默认的软件源，安装过程可能有点慢，如果你想快一点，我强烈建议你看一下`Pip的问题`里那篇文章介绍的修改`Pip`源的操作。

如果下面的安装出现`Time out`，请按方向键⬆️，将命令再执行一遍。

```shell
# 安装sphinx
pip install -U sphinx

# 安装 markdown 插件
pip install recommonmark

# 安装支持表格的插件
pip install sphinx-markdown-tables

# 如果你希望你生成的html页面中的搜索框支持中文搜索，那么这个插件也需要安装
# 这个插件有两个版本，下面的jieba3k是适用于python3的，如果你用的是python2，那么换成jieba
pip install jieba3k

# 安装主题 sphinx-rtd-theme,当然你也可以安装别的。
# 主题网址：https://sphinx-themes.org/
pip install sphinx-rtd-theme
```

### 开始配置文档项目

一切准备就绪后，新建一个文件夹，作为文档的工程文件夹，下面以`doc`为例。

```shell
mkdir doc && cd doc
```

然后执行`sphinx-quickstart`，

接着会出现很多的问题，类似下面这样：

```txt
Welcome to the Sphinx 1.8.0 quickstart utility.

Please enter values for the following settings (just press Enter to
accept a default value, if one is given in brackets).

Selected root path: .

You have two options for placing the build directory for Sphinx output.
Either, you use a directory "_build" within the root path, or you separate
"source" and "build" directories within the root path.
> Separate source and build directories (y/n) [n]: y # 源路径和输出路径分开(强烈建议这样做)

Inside the root directory, two more directories will be created; "_templates"
for custom HTML templates and "_static" for custom stylesheets and other static
files. You can enter another prefix (such as ".") to replace the underscore.
> Name prefix for templates and static dir [_]:

The project name will occur in several places in the built documentation.
> Project name: Mofan API     # 项目名称
> Author name(s): Mofan     # 作者
> Project release []: 1.0.0 # 版本号

If the documents are to be written in a language other than English,
you can select a language here by its language code. Sphinx will then
translate text that it generates into that language.

For a list of supported codes, see
http://sphinx-doc.org/config.html#confval-language.
> Project language [en]: zh_CN # 中文
```

以前的版本可能还会有后面的问题，但那些问题都可以用默认的，因为我们马上就要修改配置文件了，可以通过修改配置文件满足我们的所有需求，包括上面的问题。

完成上面的操作后，查看当前的文件夹，你会看到四个文件`source`、`build` 、`Makefile`、`make.bat`。

我们只需要关注两个文件即可：

* `source`：这编写文档的地方
* `build`：这是存放静态web文件的地方，里面的`html`文件夹就可以放到诸如`tomcat`、`nginx`等`web容器`中。

下面的操作也主要围绕`source`文件夹展开，因为这才是我们真正工作的地方。

### 编写配置文件

进入`source`目录，`conf.py`即是它的配置文件，其实就是一个地道的`Python` 文件。

```python
# Configuration file for the Sphinx documentation builder.
#
# This file only contains a selection of the most common options. For a full
# list see the documentation:
# https://www.sphinx-doc.org/en/master/usage/configuration.html

# -- Path setup --------------------------------------------------------------

# If extensions (or modules to document with autodoc) are in another directory,
# add these directories to sys.path here. If the directory is relative to the
# documentation root, use os.path.abspath to make it absolute, like shown here.
#

# 把这一块的注释去掉
import os
import sys
sys.path.insert(0, os.path.abspath('.'))


# -- Project information -----------------------------------------------------

# 这里是运行 sphinx-quickstart 后你配置的东西
project = 'Mofan API'
copyright = '2021, Mofan'
author = 'Mofan'

# The full version, including alpha/beta/rc tags
release = '1.0.0'


# -- General configuration ---------------------------------------------------

# Add any Sphinx extension module names here, as strings. They can be
# extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
# ones.

# 这里是定义插件的地方，分别是支持markdown的插件和支持markdown表格的插件
extensions = ['recommonmark',
			  'sphinx_markdown_tables',			
]


# 这个需要自己加上，这里主要说明什么格式的文件由什么解析
source_suffix = {
    '.rst': 'restructuredtext',
    '.txt': 'markdown',
    '.md': 'markdown',
}

# Add any paths that contain templates here, relative to this directory.
templates_path = ['_templates']

# The language for content autogenerated by Sphinx. Refer to documentation
# for a list of supported languages.
#
# This is also used if you do content translation via gettext catalogs.
# Usually you set "language" from the command line for these cases.

# 这里也是在运行 sphinx-quickstart 时配置的信息
language = 'zh_CN'

# List of patterns, relative to source directory, that match files and
# directories to ignore when looking for source files.
# This pattern also affects html_static_path and html_extra_path.
exclude_patterns = []


# -- Options for HTML output -------------------------------------------------

# The theme to use for HTML and HTML Help pages.  See the documentation for
# a list of builtin themes.
#

# 可以在这里修改主题
html_theme = 'sphinx_rtd_theme'

# Add any paths that contain custom static files (such as style sheets) here,
# relative to this directory. They are copied after the builtin static files,
# so a file named "default.css" will overwrite the builtin "default.css".
# html_static_path = ['_static']

# 这里要自己加上，这里对应jieba3k插件，是让web页面搜索支持中文的配置
html_search_language = 'zh'
```

完成上面的配置后，你就可以返回上级目录，进行编译生成html文档了，命令：

```shell
cd ..

make html
```

然后用浏览器打开`build/html/index.html` 文件，你会看到你配置的主题，还有一些默认的信息，这些信息来自`source/index.rst`文件。

### 编写接口文档添加目录

#### 编写文档

首先进入到source目录，然后创建文件，但别忘了在`index.rst`文件中声明你创建的文件。

```
cd source

vim hello.md
```

用`markdown`格式编写hello.md文件

```markdown
# Hello

Are you ok?
```

在index.rst文件中声明。`vim index.rst`

```rst
.. Mofan API documentation master file, created by
   sphinx-quickstart on Thu Apr  8 10:08:14 2021.
   You can adapt this file completely to your liking, but it should at least
   contain the root `toctree` directive.

Welcome to Mofan API's documentation!
=======================================

.. toctree::
   :maxdepth: 1

   hello

Indices and tables
==================

* :ref:`genindex`
* :ref:`modindex`
* :ref:`search`
```

这个文件不能是`md`格式的，需要为`rst`格式的，因为这里面包含了一些命令。

* `.. `这是一个注释，不会被编译到页面中
* `=====`：它定义文档标题，它的长度必须大于等于标题长度
* `toctree`：这是一个命令，`maxdepth`是它的参数之一，用于指定解析到哪一级的文档标题，这个可以自己换个数字看看效果就懂了
* `hello`：这里是文件的名字，无需后缀，这是和`index.rst`同级目录的。

定义文件基本介绍就这样，下面介绍创建目录，并在目录里创建文件。

#### 创建目录

我们在source文件夹里，创建`world`目录，然后在里面创建文件。不过要注意，目录里必须也要有一个`index.rst`文件，它用于描述该目录下的文件结构，和`source/index.rst`文件作用是相同的，不过`source/index.rst`文件处于根节点，相当于老大。

```shell
mkdir world

cd world

vim index.rst
```

把下面的信息放进去:

```rst
World
======

.. toctree::
   :maxdepth: 1

   mofan
```

上面的`World`是这级目录的标题，你要点击这个标题才能看到下面的`Hello,Mofan`。

如果不这样做的话，那么编译成`html`后，`Hello,Mofan`和`Hello`是同级的。

然后就得创建`mofan.md`文件了。`vim mofan.md`，写入下面的信息：

```markdown
# Hello,Mofan

very ok!
```

完成上面工作后，还要做一件最重要的事，告诉老大哥这里有一个文件夹。

编辑`source/index.rst`文件

```shell
cd ..

vim index.rst
```

在`hello`的下面添加`world/index`，同样不需要带文件后缀，类似下面这样

```rst
.. Mofan API documentation master file, created by
   sphinx-quickstart on Thu Apr  8 10:08:14 2021.
   You can adapt this file completely to your liking, but it should at least
   contain the root `toctree` directive.

Welcome to Mofan API's documentation!
=======================================

.. toctree::
   :maxdepth: 1

   hello
   world/index

Indices and tables
==================

* :ref:`genindex`
* :ref:`modindex`
* :ref:`search`
```

这个时候，既可以回到有`make.bat`的文件，运行`make html`生成`html`页面了，然后刷新浏览器就可以看到变化。

如果你发现运行`make html`后生成的页面还有你在`source`里删除的文件信息，那么，运行`make clean` 后，再运行`make install`即可。



如果想更多的了解`reStructuredText` 语法的话，可以参考[reStructuredText 简介 — Sphinx 使用手册](https://zh-sphinx-doc.readthedocs.io/en/latest/rest.html)作为一个简单的入门。

