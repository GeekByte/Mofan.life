### 主备延迟

主备延迟：同一个事务，备库执行完的时间与主库执行完的时间的差值。

与数据同步有关的时间点主要包括三个：

1. 主库A 执行完一个事务，然后写入 binlog，记写入完后的时刻为 T1；
2. 之后将 binlog 传给 备库B，将 备库B 接收完 binlog 的时刻记为 T2;
3. 将备库B 执行完这个事务的时刻记为 T3。

此时，主备延迟的时间为：T3 - T1。

主备延迟的时间单位是 秒(s)，可通过在从库执行 `show slave status` 命令查看，其中 `seconds_behind_master` 的时间就是 主备延迟 时间。

#### seconds_behind_master 的计算方式

每个事务的 binlog 里面都有一个时间字段，用于记录主库上写入的时间；备库取出当前正在执行的事务的时间字段的值，计算它与当前系统时间的差值，得到 `seconds_behind_master`。

##### 如果主备库机器的系统时间设置不一致，会不会导致主备延迟的值不准？

备库连接到主库的时候，会通过执行 `SELECT UNIX_TIMESTAMP()` 函数来获得当前主库的系统时间。如果这时候发现主库的系统时间与自己不一致，备库在执行 `seconds_behind_master` 计算的时候会自动扣掉这个差值。

需要说明的是，在网络正常的情况下，主库 到 备库的日志传输时间是很短的，也就是 T2 - T1 的值很小，主备延迟的主要来源是**备库接收完 binlog 和 执行完这个事务之间的时间差，也就是 T3 - T2。**所以，主备延迟的具体表现是：**备库消费中转日志（relay log）的速度小于主库生产 binlog 的速度。**

### 备库消费速度小于主库生产速度的原因

1. 备库主机性能若较弱，但在现在的部署中，由于备库随时有变成主库的可能，所以备库一般也会选用和主库相同规格的主机。

2. 备库压力大。比如一些运营后台的需要的分析语句，导致备库压力大。

    > 备库压力大的解决方法：
    >
    > * 采用 一主多从 架构。除了备库外，准备多个从库，让这些从库分担读的压力。
    > * 将 binlog 输出到外部系统，比如 Hadoop，让外部系统提供统计类查询能力。

3. 大事务。比如一个事务在主库执行了10分钟，会导致从库延迟10分钟。典型的大事务场景有：使用 delete 语句删除太多数据。
4. 备库的并行复制能力。



由于主备延迟的存在，在主备切换时就会有不同的策略：

1. 可靠性优先策略：当seconds_behind_master小于某个值时，将主库readonly，当备库seconds_behind_master = 0时，将备库可读写，业务切换到备库。

